#pragma once

#include "bx/allocator.h"
#include "bxx/hash_table.h"
#include "resource_lib.h"

namespace termite
{
    struct MemoryBlock;
    class Font;
    class IoDriverI;
    struct Texture;

    enum class FontFlags : uint8_t
    {
        Normal = 0x0,
        Bold = 0x1,
        Italic = 0x2,
        Underline = 0x4
    };

    // Font Library
    result_t initFontLib(bx::AllocatorI* alloc, IoDriverI* ioDriver);
    void shutdownFontLib();

    TERMITE_API result_t registerFont(const char* fntFilepath, const char* name, uint16_t size = 0, FontFlags flags = FontFlags::Normal);
    TERMITE_API void unregisterFont(const char* name, uint16_t size = 0, FontFlags flags = FontFlags::Normal);
    TERMITE_API const Font* getFont(const char* name, uint16_t size = 0, FontFlags flags = FontFlags::Normal);

    struct FontKerning
    {
        uint32_t secondGlyph;
        float amount;
    };

    struct FontGlyph
    {
        uint32_t glyphId;
        float x;
        float y;
        float width;
        float height;
        float xoffset;
        float yoffset;
        float xadvance;
        uint16_t numKerns;
        uint32_t kernIdx;
    };

    class Font
    {
        friend result_t termite::registerFont(const char*, const char*, uint16_t, FontFlags);

    private:
        bx::AllocatorI* m_alloc;
        char m_name[32];
        ResourceHandle m_textureHandle;
        uint32_t m_numChars;
        uint32_t m_numKerns;
        uint16_t m_lineHeight;
        uint16_t m_baseValue;
        uint32_t m_fsize;
        uint32_t m_charWidth;    // fixed width fonts
        FontGlyph* m_glyphs;
        FontKerning* m_kerns;
        bx::HashTableInt m_charTable;
        ResourceLib* m_resLib;

    public:
        Font(bx::AllocatorI* alloc);
        static Font* create(const MemoryBlock* mem, const char* fntFilepath, bx::AllocatorI* alloc, ResourceLib* ds = nullptr);

    public:
        ~Font();

        const char* getInternalName() const
        {
            return m_name;
        }

        uint16_t getLineHeight() const
        {
            return m_lineHeight;
        }

        int getCharCount() const
        {
            return m_numChars;
        }

        uint32_t getCharWidth() const
        {
            return m_charWidth;
        }

        Texture* getTexture() const
        {
            return (Texture*)getResourceObj(m_resLib, m_textureHandle);
        }

        int findGlyph(uint32_t glyphId) const
        {
            int index = m_charTable.find(glyphId);
            return index != -1 ? m_charTable.getValue(index) : -1;
        }

        const FontGlyph& getGlyph(int glyphIdx) const
        {
            assert(glyphIdx != -1);
            return m_glyphs[glyphIdx];
        }

        float getTextWidth(const char* text, int len = -1, float* firstcharWidth = nullptr);
        float applyKern(int glyphIdx, int nextGlyphIdx) const;
    };
} // namespace termite

C11_DEFINE_FLAG_TYPE(termite::FontFlags);
